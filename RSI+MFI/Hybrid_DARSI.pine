//@version=6
indicator(title="Hybrid RSI+MFI + TMA + USDT.D [Clean]", shorttitle="Hybrid_DARSI", format=format.price, precision=2)

// ============================================================================
// HYBRID SETTINGS
// ============================================================================
grp_hybrid = "Hybrid Oscillator Settings"
rsiWeight = input.float(0.5, "RSI Weight (0.0 - 1.0)", minval=0, maxval=1, step=0.1, group=grp_hybrid, tooltip="How much RSI influences the line. 0.5 is equal weight with MFI.")
mfiWeight = 1.0 - rsiWeight

// RSI Inputs
rsiLengthInput = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput = input.source(close, "RSI Source", group="RSI Settings")

// MFI Inputs
mfiLengthInput = input.int(14, minval=1, maxval=2000, title="MFI Length", group="MFI Settings")

// ============================================================================
// USDT DOMINANCE CORRELATION SETTINGS
// ============================================================================
grp_usdt    = "USDT Dominance Correlation"
showUsdt    = input.bool(true, "Show USDT.D Correlation Line", group=grp_usdt)
invertUsdt  = input.bool(true, "Invert USDT.D (Follows Market)", group=grp_usdt, tooltip="Inverts USDT.D so it moves in the same direction as the asset. When they move apart, it signals manipulation.")
usdtColor   = input.color(color.new(#ffeb3b, 20), "USDT.D Line Color", group=grp_usdt)

// ============================================================================
// CALCULATIONS
// ============================================================================
// 1. Calculate Asset Hybrid
rsi = ta.rsi(rsiSourceInput, rsiLengthInput)
mfi = ta.mfi(hlc3, mfiLengthInput)
hybridOsc = (rsi * rsiWeight) + (mfi * mfiWeight)

// 2. Calculate USDT.D Hybrid Correlation
// Fetches USDT.D and applies the inversion logic to match the 0-100 scale
usdtRaw    = request.security("CRYPTOCAP:USDT.D", timeframe.period, hlc3)
usdtRsi    = ta.rsi(usdtRaw, rsiLengthInput)
usdtHybrid = invertUsdt ? (100 - usdtRsi) : usdtRsi

// ============================================================================
// TMA SETTINGS (Smoothed MA based on Hybrid)
// ============================================================================
showSmma = input.bool(true, title="Show TMA (Smoothed MA)", group="TMA Settings")
smmaLen = input.int(50, minval=1, title="TMA Length", group="TMA Settings")

var float smma = na
smmaSrc = hybridOsc
smma := na(smma[1]) ? ta.sma(smmaSrc, smmaLen) : (smma[1] * (smmaLen - 1) + smmaSrc) / smmaLen

// ============================================================================
// LEVELS & VISUALS
// ============================================================================
h_upper = hline(70, "Upper Band", color=#787B86, linestyle=hline.style_solid)
h_mid   = hline(50, "Middle Band", color=color.new(#787B86, 50))
h_lower = hline(30, "Lower Band", color=#787B86, linestyle=hline.style_solid)
fill(h_upper, h_lower, color=color.rgb(126, 87, 194, 95), title="Background Fill")

// Plot USDT.D Correlation (Dashed Gold Line)
plot(showUsdt ? usdtHybrid : na, "USDT.D Correlation", color=usdtColor, linewidth=1, style=plot.style_linebr)

// Plot the Unified Hybrid Line
// The line turns bright white when above the TMA, and semi-transparent when below
lineColor = hybridOsc > smma ? color.white : color.new(color.white, 30)
hybridPlot = plot(hybridOsc, "Hybrid RSI+MFI", color=lineColor, linewidth=3)

// Plot TMA (The smoothed average)
plot(showSmma ? smma : na, "TMA on Hybrid", linewidth=1, color=color.white)

// Gradient Fills based on Hybrid Line position relative to levels
midLinePlot = plot(50, color=na, editable=false, display=display.none)
fill(hybridPlot, midLinePlot, 100, 70, top_color=color.new(color.green, 20), bottom_color=color.new(color.green, 100), title="Overbought Gradient")
fill(hybridPlot, midLinePlot, 30, 0, top_color=color.new(color.red, 100), bottom_color=color.new(color.red, 20), title="Oversold Gradient")