//@version=6
indicator(title="RSI + MFI Hybrid + TMA + Divergencias", shorttitle="Hybrid_RSI_MFI_DIV", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// ============================================================================
// HYBRID SETTINGS
// ============================================================================
grp_hybrid = "Hybrid Oscillator Settings"
rsiWeight = input.float(0.5, "RSI Weight (0.0 - 1.0)", minval=0, maxval=1, step=0.1, group=grp_hybrid, tooltip="How much RSI influences the line. 0.5 is equal weight with MFI.")
mfiWeight = 1.0 - rsiWeight

// RSI Inputs
rsiLengthInput = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput = input.source(close, "RSI Source", group="RSI Settings")

// MFI Inputs
mfiLengthInput = input.int(14, minval=1, maxval=2000, title="MFI Length", group="MFI Settings")

// ============================================================================
// CALCULATIONS
// ============================================================================
// 1. Calculate RSI
rsi = ta.rsi(rsiSourceInput, rsiLengthInput)

// 2. Calculate MFI
mfi = ta.mfi(hlc3, mfiLengthInput)

// 3. Create Unified Hybrid Line
// We combine them into one unified value (0-100 scale)
hybridOsc = (rsi * rsiWeight) + (mfi * mfiWeight)

// ============================================================================
// TMA SETTINGS (Smoothed MA based on Hybrid)
// ============================================================================
showSmma = input.bool(true, title="Show TMA (Smoothed MA)", group="TMA Settings")
smmaLen = input.int(50, minval=1, title="TMA Length", group="TMA Settings")

var float smma = na
smmaSrc = hybridOsc
smma := na(smma[1]) ? ta.sma(smmaSrc, smmaLen) : (smma[1] * (smmaLen - 1) + smmaSrc) / smmaLen

// ============================================================================
// DIVERGENCE SETTINGS
// ============================================================================
GRP_DIV = "Divergence Settings"
plotBull = input.bool(true, title="Plot Bullish", group=GRP_DIV)
plotHiddenBull = input.bool(true, title="Plot Hidden Bullish", group=GRP_DIV)
plotBear = input.bool(true, title="Plot Bearish", group=GRP_DIV)
plotHiddenBear = input.bool(true, title="Plot Hidden Bearish", group=GRP_DIV)
lbR = input.int(5, title="Pivot Lookback Right", group=GRP_DIV)
lbL = input.int(5, title="Pivot Lookback Left", group=GRP_DIV)
rangeUpper = input.int(60, title="Max of Lookback Range", group=GRP_DIV)
rangeLower = input.int(5, title="Min of Lookback Range", group=GRP_DIV)

// ============================================================================
// LEVELS & VISUALS
// ============================================================================
h_upper = hline(70, "Upper Band", color=#787B86, linestyle=hline.style_solid)
h_mid   = hline(50, "Middle Band", color=color.new(#787B86, 50))
h_lower = hline(30, "Lower Band", color=#787B86, linestyle=hline.style_solid)
fill(h_upper, h_lower, color=color.rgb(126, 87, 194, 95), title="Background Fill")

// Plot the Unified Hybrid Line
lineColor = hybridOsc > smma ? color.white : color.new(color.white, 30)
hybridPlot = plot(hybridOsc, "Hybrid RSI+MFI", color=lineColor, linewidth=3)

// Optional: Plot original RSI/MFI as thin faint lines for context
plot(rsi, "Original RSI", color=color.new(color.blue, 70), linewidth=1, display=display.none)
plot(mfi, "Original MFI", color=color.new(color.teal, 70), linewidth=1, display=display.none)

// Plot TMA
plot(showSmma ? smma : na, "TMA on Hybrid", linewidth=1, color=color.white)

// Gradient Fills based on Hybrid Line
midLinePlot = plot(50, color=na, editable=false, display=display.none)
fill(hybridPlot, midLinePlot, 100, 70, top_color=color.new(color.green, 20), bottom_color=color.new(color.green, 100), title="Overbought Gradient")
fill(hybridPlot, midLinePlot, 30, 0, top_color=color.new(color.red, 100), bottom_color=color.new(color.red, 20), title="Oversold Gradient")

// ============================================================================
// HYBRID DIVERGENCE CALCULATION (Calculated on the Hybrid line)
// ============================================================================
_inRange(bool cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

// Pivot detection on Hybrid Oscillator
plFound = not na(ta.pivotlow(hybridOsc, lbL, lbR))
phFound = not na(ta.pivothigh(hybridOsc, lbL, lbR))

hybridLBR = hybridOsc[lbR]
lowLBR    = low[lbR]
highLBR   = high[lbR]

// Regular Bullish
oscHL = hybridLBR > ta.valuewhen(plFound, hybridLBR, 1) and _inRange(plFound[1])
priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
bullCond = plotBull and priceLL and oscHL and plFound

// Hidden Bullish
oscLL = hybridLBR < ta.valuewhen(plFound, hybridLBR, 1) and _inRange(plFound[1])
priceHL = lowLBR > ta.valuewhen(plFound, lowLBR, 1)
hiddenBullCond = plotHiddenBull and priceHL and oscLL and plFound

// Regular Bearish
oscLH = hybridLBR < ta.valuewhen(phFound, hybridLBR, 1) and _inRange(phFound[1])
priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
bearCond = plotBear and priceHH and oscLH and phFound

// Hidden Bearish
oscHH = hybridLBR > ta.valuewhen(phFound, hybridLBR, 1) and _inRange(phFound[1])
priceLH = highLBR < ta.valuewhen(phFound, highLBR, 1)
hiddenBearCond = plotHiddenBear and priceLH and oscHH and phFound